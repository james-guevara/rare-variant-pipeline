// Nextflow configuration for rare variant pipeline

// ============================================================================
// Default parameters (can be overridden via command line or profiles)
// ============================================================================

params {
    outdir = "output"
    trace_prefix = ""
    regions_per_chunk = 1000

    // Containers (sandbox directories)
    bcftools_container = "/expanse/projects/sebat1/s3/data/sebat/g2mh/scripts/scripts_for_rare_pipeline/bcftools:1.22--h3a4d415_1"
    vep_container = "/expanse/projects/sebat1/s3/data/sebat/g2mh/scripts/scripts_for_rare_pipeline/ensembl-vep_115.2--pl5321h2a3209d_1.with_samtools"

    // VEP resources (absolute paths - symlinks don't work inside containers)
    vep_cache = "/expanse/projects/sebat1/s3/data/sebat/g2mh/scripts/scripts_for_rare_pipeline/VEP_CACHE"
    vep_plugins = "/expanse/projects/sebat1/s3/data/sebat/g2mh/scripts/scripts_for_rare_pipeline/VEP_PLUGINS_ALL"
    loftee_path = "/expanse/projects/sebat1/s3/data/sebat/g2mh/scripts/scripts_for_rare_pipeline/VEP_PLUGINS/loftee"
    resources_base = "/expanse/projects/sebat1/s3/data/sebat/g2mh/scripts/scripts_for_rare_pipeline/resources"
    reference = "/expanse/projects/sebat1/j3guevar/GRCh38_reference_genome/GRCh38_full_analysis_set_plus_decoy_hla.fa"

    // Python scripts and resources
    python_env = "/home/j3guevar/micromamba/envs/python3.12_env_default"
    reformat_script = "${projectDir}/scripts/reformat_variants.py"
    family_query_script = "${projectDir}/scripts/family_query.py"
    resolve_script = "${projectDir}/scripts/resolve_family_genotypes.py"
    merge_script = "${projectDir}/scripts/merge_genotypes_annotations.py"
    resources_dir = "${projectDir}/resources"
}

// ============================================================================
// Singularity settings
// ============================================================================

singularity {
    enabled = true
    autoMounts = true
    runOptions = '-B /expanse/projects/sebat1'
}

// ============================================================================
// Process defaults
// ============================================================================

process {
    errorStrategy = "ignore"
    executor = "slurm"
    queue = "ind-shared"
    clusterOptions = "--account=ddp195 --ntasks=1 --nodes=1"
    beforeScript = "module load cpu/0.17.3b singularitypro"

    // Output directories per process
    withName: 'BCFTOOLS_FILTER' {
        publishDir = [path: "output/sites", mode: "link"]
    }
    withName: 'VEP_ANNOTATE' {
        publishDir = [path: "output/vep", mode: "link"]
    }
    withName: 'SPLIT_VEP' {
        publishDir = [path: "output/variants", mode: "link"]
    }
    withName: 'REFORMAT_VARIANTS' {
        publishDir = [path: "output/reformat", mode: "link"]
    }
    withName: 'SCATTER_BED' {
        publishDir = [path: "output/scatter", mode: "link"]
    }
    withName: 'FAMILY_QUERY' {
        publishDir = [path: "output/family_query", mode: "link"]
    }
    withName: 'GATHER_GENOTYPES' {
        publishDir = [path: "output/gather", mode: "link"]
    }
    withName: 'RESOLVE_GENOTYPES' {
        publishDir = [path: "output/resolve", mode: "link"]
    }
    withName: 'MERGE_ANNOTATIONS' {
        publishDir = [path: "output/merged", mode: "link"]
    }
    withName: 'SORT_INDEX' {
        publishDir = [path: "output/indexed", mode: "link"]
    }
}

// ============================================================================
// Executor settings
// ============================================================================

executor {
    queueSize = 50
    submitRateLimit = "20/1min"
}

// ============================================================================
// Reports and tracing
// ============================================================================

trace {
    enabled = true
    file = "reports/${params.trace_prefix}trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,status,exit,submit,start,complete,duration,realtime,cpus,memory,rss,vmem,%cpu,%mem,queue,container'
}

report {
    enabled = true
    file = "reports/${params.trace_prefix}report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "reports/${params.trace_prefix}timeline.html"
    overwrite = true
}

// ============================================================================
// Profiles for different cohorts
// ============================================================================

profiles {
    spark_wgs {
        params.vcf_dir = "/expanse/projects/sebat1/s3/data/sebat/SSC_JG/gatk"
        params.vcf_pattern = "wgs_12519_genome.deepvariant.{chrom}.vcf.gz"
        params.ped_file = "${projectDir}/resources/SPARK_iWGS_v1.1.ped"
    }

    spark_iwes {
        params.vcf_dir = "/expanse/projects/sebat1/s3/data/sebat/SPARK_iWES_v3/variants/snv/deepvariant/pvcf"
        params.vcf_pattern = "SPARK.iWES_v3.2024_08.deepvariant.{chrom}.vcf.gz"
        params.ped_file = "${projectDir}/resources/SPARK_iWES_v3.ped"
    }

    ssc {
        params.vcf_dir = "/expanse/projects/sebat1/s3/data/sebat/SSC_JG/gatk"
        params.vcf_pattern = "{chrom}.masked.vcf.gz"
        params.ped_file = "${projectDir}/resources/SSC.ped"
    }
}

// ============================================================================
// Conda/Micromamba settings
// ============================================================================

conda {
    enabled = true
    useMicromamba = true
}

dag {
    enabled = true
    file = "reports/${params.trace_prefix}dag.html"
    overwrite = true
}

// Workflow completion summary
workflow.onComplete = {
    println """
    ===========================================
    Workflow completed: ${workflow.success ? 'SUCCESS' : 'FAILED'}
    Duration: ${workflow.duration}
    Exit status: ${workflow.exitStatus}
    ===========================================
    """.stripIndent()
}

manifest {
    name = 'rare-variant-pipeline'
    author = 'James Guevara'
    description = 'Rare variant annotation and family genotype pipeline'
    version = '1.0.0'
    mainScript = 'main.nf'
    nextflowVersion = '>=25.10.0'
}
